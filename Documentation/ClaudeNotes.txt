TUTANKHAM MAP EDITOR - COMPLETE STATUS DOCUMENT FOR CLAUDE #5

==============================================================================
DISCOVERED DATA STRUCTURE
==============================================================================

ROM Files:
- Tile ROMs: c1.1i, c2.2i, c3.3i, c4.4i, c5.5i (graphics data, 32 tiles each)
- Visual Map ROM: c8.8i (tile placement for all maps)
- Logical Map ROMs: c6.6i, c7.7i (collision/physics data)
- Object Data ROMs: m1.1h, m2.2h (game objects, spawn points, items)

Map Structure:
- 4 maps total
- 12 rows × 64 columns (rotated 90° in storage)
- Coordinate system: XX = row * 0x08, YYYY = column * 0x08
- XX range: 0x00 to 0x58 (12 tiles @ 0x08 each)
- YYYY range: 0x0000 to 0x01F8 (64 tiles @ 0x08 each)

Difficulty Levels:
- 4 difficulty levels (not 3!)
- Visual/logical maps are SHARED between difficulties
- Object enable/disable states vary per difficulty
- Only Difficulty 1 allows visual/logical map editing

Object Data Block Structure (per map/difficulty):
Base Offset: 0x0629 (Map1/Diff1 starts here, not 0x0636!)
Block Size: 0x0148 (328 bytes per map/difficulty)
Block Calculation: offset = 0x0629 + ((difficulty * 4) + map_index) * 0x0148

Block Layout:
+0x00: Player Start Position (YY YY XX) - 3 bytes
+0x03: Respawn Point 1 (YY YY XX) - 3 bytes
+0x06: Respawn Point 2 (YY YY XX) - 3 bytes
+0x09: Respawn Point 3 (YY YY XX) - 3 bytes
+0x0C: Respawn Count (0x01 to 0x03) - 1 byte
+0x0D: Items Block Start (14 items × 16 bytes = 224 bytes)
       Item Format: AA 00 00 00 00 YY YY XX 00 00 00 00 00 00 00 TT
       - AA = Active flag (0x01 = active, 0x00 = inactive)
       - YY YY = Column coordinate (2 bytes)
       - XX = Row coordinate (1 byte)
       - TT = Tile ID (0x62=treasure, 0x6F=ring, 0x70=key, 0x72=keyhole)
+0xED: Separator (0x00) - 1 byte
+0xEE: Teleports Block (6 teleports × 8 bytes = 48 bytes)
       Teleport Format: YY YY BR TR + 00 00 00 00
       - YY YY = Column coordinate (2 bytes, same for both ends)
       - BR = Bottom Row X coordinate
       - TR = Top Row X coordinate
       - Teleporters MUST be in same column (vertical only)
+0x11E: Separator (0x00) - 1 byte
+0x11F: Spawners Block (7 spawners × 4 bytes = 28 bytes)
        Spawner Format: YY YY XX + 00
        - YY YY = Column coordinate (2 bytes)
        - XX = Row coordinate (1 byte)

Map Offsets Confirmed:
Map 1/Diff 1: 0x0629
Map 2/Diff 1: 0x0771 (0x0629 + 0x0148)
Map 3/Diff 1: 0x08C6
Map 4/Diff 1: 0x0A0E
Map 1/Diff 2: 0x0B56
(continues for all 16 combinations: 4 maps × 4 difficulties)

==============================================================================
COMPOSITE OBJECT DEFINITIONS
==============================================================================

Door (3×3 block):
Visual Tiles:
  115, 116, 117
  118, 119, 120
  121, 122, 123
Logical Bytes:
  [00,00] [00,06] [00,00]
  [55,06] [F6,6E] [F6,06]
  [00,00] [F0,66] [F0,00]
Rules:
- Only ONE door per map
- Cannot be deleted, only moved
- Door is movable by clicking and dragging

Teleporter (3×1 vertical):
Visual Tiles: 100, 38, 101
Logical Bytes: [55,55], [00,00], [55,55]
Rules:
- Always placed in PAIRS
- Both must be in same column
- Two-phase placement: place first, then place second in same column only
- Deleting one teleporter deletes the entire pair and object entry
- ESC cancels placement

Spawners (4 directional variants):
Right-facing (2×3):
  Visual: 29, 15 / 27, 38 / 24, 21
  Logical: [55,55][55,55] / [55,55][00,00] / [55,55][55,55]

Left-facing (2×3):
  Visual: 15, 16 / 38, 18 / 21, 20
  Logical: [55,55][55,55] / [00,00][55,55] / [55,55][55,55]

Up-facing (3×2):
  Visual: 27, 38, 18 / 24, 21, 20
  Logical: [55,55][00,00][55,55] / [55,55][55,55][55,55]

Down-facing (3×2):
  Visual: 29, 15, 16 / 27, 38, 18
  Logical: [55,55][55,55][55,55] / [55,55][00,00][55,55]

Spawner tiles (should be excluded from palette): 0x0F, 0x10, 0x12, 0x14, 0x15, 0x18, 0x1B, 0x1D

==============================================================================
ITEM/TREASURE SYSTEM
==============================================================================

Item Tiles and Pickup Rules:
- Key (0x70): Can ONLY be picked up from side → must be in tile 0x22 (side-accessible box)
- Treasure (0x62): Can ONLY be picked up from below → must be in tile 0x4A (bottom-accessible box)
- Ring (0x6F): Can ONLY be picked up from above → must be in tile 0x21 (top-accessible box)
- Keyhole (0x72): No tile constraint

Filled vs Empty Box Logic:
- Visual map ALWAYS contains EMPTY boxes (0x4A, 0x21, 0x22)
- Object data contains the FILLED tile ID (0x62, 0x6F, 0x70)
- Editor displays FILLED icon as overlay so user knows item is there
- When placing filled box from palette:
  1. Write empty box to visual map
  2. Create object entry with filled tile ID
  3. Set coordinates properly

Map Validation on Load:
- If filled box tile (0x62, 0x6F, 0x70) found on visual layer:
  - Check if object entry exists at those coordinates
  - Replace visual tile with corresponding empty box
  - If no object exists, remove filled tile entirely (convert to empty path)

Key/Keyhole Validation:
- Number of keys must be >= number of keyholes
- If keyholes > keys, display warning (level is unwinnable)

==============================================================================
SPAWN/RESPAWN SYSTEM
==============================================================================

Player Start:
- Tile for visualization: 0x29 (forward-facing player sprite)
- Stored at offset +0x00 in object block
- Format: YY YY XX (3 bytes)
- Display with "START" label in editor

Respawn Points:
- Tile for visualization: 0x17 (flame animation)
- Up to 3 respawn points per map
- Stored at offsets +0x03, +0x06, +0x09
- Respawn count stored at +0x0C
- Display with "R1", "R2", "R3" labels in editor

==============================================================================
TILE PALETTE ORGANIZATION
==============================================================================

Tiles to KEEP (organized by category):

WALLS (0x00-0x0E, 0x11, 0x13, 0x1F-0x22, 0x26-0x28):
- 0x00 to 0x0E (15 wall tiles, excluding 0x0F which is spawner)
- 0x11 (17 decimal) - wall tile
- 0x13 (19 decimal) - wall tile
- 0x1F to 0x22 (31-34 decimal) - more walls
- 0x26 (38 decimal) - THE EMPTY PATH TILE (critical!)
- 0x27, 0x28 (39-40 decimal) - walls

SPAWN POINTS:
- 0x29 (41 decimal) - player start visualization
- 0x17 (23 decimal) - respawn point visualization (flame)

TREASURES (group empty and filled together):
- 0x21 (33) - Ring box EMPTY
- 0x6F (111) - Ring box FILLED
- 0x22 (34) - Key box EMPTY
- 0x70 (112) - Key box FILLED
- 0x4A (74) - Treasure box EMPTY
- 0x62 (98) - Treasure box FILLED

Tiles to EXCLUDE:
- 0x10, 0x16, 0x1E (keyhole animations)
- 0x17, 0x19, 0x1A, 0x1C (flame animations - EXCEPT keep 0x17 for respawn viz)
- 0x0F, 0x12, 0x14, 0x15, 0x18, 0x1B, 0x1D (spawner pieces - placed via composite)
- 0x23-0x25 (player sprites)
- 0x29-0x49 (sprite animations - EXCEPT keep 0x29 for start viz)
- 0x4B-0x61 (animations)
- 0x63 (explosion)
- 0x64-0x65 (teleporter pillars - placed via composite)
- 0x66-0x6E (animations)
- 0x71-0x72 (keyhole animations)
- 0x73-0x7B (door tiles - placed via composite)
- 0x7C-0x9F (remaining animations)

==============================================================================
IMPLEMENTED FEATURES IN V5 (LAST WORKING VERSION)
==============================================================================

Working in V5:
- Tile loading and rendering with rotation
- 4 map support with correct palettes
- Visual map (c8) editing and saving
- Logical map (c6/c7) editing and saving with byte-pair format
- Tile palette with zoom
- Grid overlay toggle
- Hex tile ID display toggle
- Backup system for ROM files
- Door detection and drag-to-move
- Map coordinate hover display (XX, YYYY format)
- Auto-generation of logical bytes when placing tiles

==============================================================================
FEATURES TO IMPLEMENT IN V6 (WHAT WE WERE ADDING)
==============================================================================

NEW FEATURES NEEDED:

1. Object Data Loading/Saving:
   - Validate Teleports - There is an error in the original game ROM for a non-existent second teleport.  Code Rom shows it, but Visually doesn't exist.  It should be 'removed' because it is impossible to use/has no map representation.  In short, teleport count should be validated from the visual representation and then enforced in code rom data
   - Validate saves back to m1/m2, c6/c7/c8 with correct offsets

2. Composite Object Palette:
   - Apply scaling fixes to the width of the Palette sections
   - Ensure we're using maximum width of the window to properly fill the space by scale

3. Special In-Game Objects:
   - Attempt to place a Teleporter - it is the wrong orientation.  Need to fix that.  
   - Adding Respawn spots to the map doesn't 'consume' from the pool, nor does it seem to add them as a respawn, just adding the flame graphic..  
   - Need to ensure that if there are 1, 2, 3 keyholes that there are 1, 2, 3 keys
   - Probably should add a section to Object Counters that counts keyholes and ensures equal or greater number of keys available or show error.

Other Items:
   - Allow for bulk paste/fill function to select a region and paste all of a single type of tile (all walking space, all single wall type, etc.)
   - Move the save/export buttons, coordinates, etc from under the map to the left window - consolidate all that to the left side.  
   - What's the difference between 'Save All' and 'Export'?   I don't understand the need for two buttons.  
   - Shouldn't we make the displayed coordinates the same as the ingame ones?  Why are we forcing a top down coordinate system?  We went to a lot of trouble to convert numbers, but... seriously - isn't it simpler to just represent it and handle it as it's actually used? 
   - I love the 'show grid' and 'show objects' buttons, but the 'hex tile ids' button seems silly.  We should always show the Hex Value, period.

Future: 
   - Add actual Tile editing

==============================================================================
KNOWN ISSUES/EDGE CASES
==============================================================================

- Unknown bytes at 0x766-0x770 between Map1 and Map2 (still investigating)
- Copyright symbol checksum exists somewhere (location unknown)
- Can door be moved to different rows? (every map has same row, different columns)
- Can items/teleporters be at XX of 0x00 or 0x55? (needs testing)
- Teleport internal separator may just be spacing, not required
- Maybe 8 spawns possible? (7th slot needs testing)

==============================================================================
COORDINATE SYSTEM REFERENCE
==============================================================================

Visual Map Layout: 12 rows (height) × 64 columns (width)
Logical Map Layout: 64 rows × 14 columns (rotated, includes CC borders)

Visual to Logical Mapping:
- Visual column → Logical row
- Visual row → Logical column + 1 (accounting for left border)

Game Coordinates:
- Row → XX coordinate = row * 0x08
- Column → YYYY coordinate = column * 0x08

==============================================================================
END OF STATUS DOCUMENT
==============================================================================

What needs to be added for V6:
Teleporter two-phase placement with column constraint
Object counters display
Key/keyhole validation
Difficulty 1 editing lock
Map sync across difficulties
Teleporter pair deletion
Spawn/respawn overlay visualization

